---
tags: [ 'defineCustomElement()']

---

# 自定义元素

## Vue 自定义元素 defineCustomElement() 详解

### 一、什么是自定义元素

自定义元素(Web Components)是浏览器原生支持的组件化方案，而 Vue 3.2+ 提供了 `defineCustomElement()` 方法，让我们能够使用 Vue 组件 API 来创建原生自定义元素。

### 二、defineCustomElement() 核心 API

`defineCustomElement()` 方法接收一个 Vue 组件选项对象，返回一个可以扩展 HTMLElement 的构造函数。

#### 基本属性

```typescript
import { defineCustomElement } from 'vue'

const MyElement = defineCustomElement({
  // 常规 Vue 组件选项
  props: {},
  emits: [],
  setup() {},
  template: `
    <div>
      <slot></slot>
    </div>
  `,
  
  // 自定义元素特有选项
  styles: [], // 内联 CSS 字符串数组
  shadowRootOptions: { mode: 'open' } // Shadow DOM 配置
})
```

#### 直接使用 defineCustomElement()创建自定义元素

```typescript
// sy-element.ts
import { defineCustomElement } from 'vue'

export default defineCustomElement({
  props: {
    name: {
      type: String,
      default: 'World'
    }
  },
  emits: ['custom-click'],
  template: `
    <div>
      <div class="greeting">Hello, {{ name }}!</div>
      <button @click="handleClick">Click me</button>
    </div>
  `,
  setup(props, { emit }) {
    const handleClick = () => {
      emit('custom-click', 'Button clicked!')
    }
    
    return {
      handleClick
    }
  },
  styles: [
    `.greeting { 
      color: blue; 
      font-size: 18px;
      margin-bottom: 10px;
    }`
  ]
})
```

```typescript
// main.ts
import { defineCustomElement } from 'vue'
import CustomDefineElement from './sy-element.ts'

// 将自定义元素注册到全局
customElements.define('my-element', CustomDefineElement)
```

#### 主要 API 说明

1. **props**：定义组件接收的属性，会转换为自定义元素的 HTML 属性
2. **emits**：定义组件触发的事件
3. **styles**：定义组件的样式，会注入到 Shadow DOM 中
4. **shadowRootOptions**：配置 Shadow DOM 的行为

### 三、完整代码示例

#### 1. 创建自定义元素组件

```typescript
// custom-element.ce.vue
<template>
  <div class="greeting">Hello, {{ name }}!</div>
  <button @click="handleClick">Click me</button>
</template>

<script setup lang="ts">
defineProps({
  name: {
    type: String,
    default: 'World'
  }
})

const emit = defineEmits(['custom-click'])

const handleClick = () => {
  emit('custom-click', 'Button clicked!')
}
</script>

<style scoped>
button {
  padding: 8px 16px;
  background-color: #007bff;
  color: #fff;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

button:hover {
  background-color: #0056b3;
}

.greeting {
  color: blue;
  font-size: 18px;
  margin-bottom: 10px;
}
</style>
```

#### 2. 注册自定义元素

```typescript
// main.ts
import { defineCustomElement } from 'vue'
import CustomElement from './sy-element.ce.vue'

const CustomElementCE = defineCustomElement(CustomElement)

// 将自定义元素注册到全局
customElements.define('my-element', CustomElementCE)
```

#### 3. 在 HTML 中使用

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vue Custom Element</title>
</head>
<body>
  <my-element id="element1" name="Alice"></my-element>

  <script type="module" src="/main.ts"></script>
</body>
</html>
```

### 四、使用 Vite 打包配置

在 `vite.config.ts` 中需要添加自定义元素支持：

> 可以不写 也能进行正常处理
```typescript
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'

export default defineConfig({
  plugins: [
    vue({
      template: {
        compilerOptions: {
          // 将自定义元素视为原生元素 
          isCustomElement: (tag) => tag.includes('-')
        }
      }
    })
  ],
  build: {
    // 确保样式内联
    cssCodeSplit: false
  }
})
```

### 五、实际应用场景

1. **微前端架构**：在不同框架间共享组件
2. **渐进式增强**：在非 Vue 项目中使用 Vue 组件
3. **设计系统**：创建框架无关的 UI 组件库
4. **第三方集成**：提供可嵌入任何网页的组件

### 六、注意事项

1. **props 限制**：只能传递字符串或 JSON 可序列化的数据
2. **样式隔离**：默认使用 Shadow DOM 实现样式隔离
3. **生命周期**：遵循自定义元素的生命周期而非 Vue 组件
4. **兼容性**：现代浏览器支持良好，旧版浏览器可能需要 polyfill

### 七、通俗总结

`defineCustomElement()` 就像是给 Vue 组件穿上了一件"浏览器原生"的外衣，让它能够以 HTML 标签的形式在任何网页中使用，而不需要 Vue 环境。这样做的好处是：

1. **通用性**：可以在任何框架甚至无框架的页面中使用
2. **隔离性**：自带样式和作用域隔离
3. **标准化**：遵循 Web Components 标准，未来兼容性好

就像乐高积木一样，你可以用 Vue 的方式设计和构建组件，然后把它变成一块标准的、可以在任何地方使用的"积木"。

### 八、完整可运行示例

以下是完整的项目结构：

```
project/
├── index.html
├── main.ts
├── sy-element.ce.vue
└── vite.config.ts
```

按照上述代码配置后，运行 `vite build` 会生成可在任何 HTML 页面中直接使用的 JS 文件，只需通过 `<script>` 标签引入即可使用自定义元素。


### 九、打包使用


1.项目结构
```
project/
├── index.html
├── main.ts
├── sy-element.ts
└── vite.config.ce.ts
```

2.在 `sy-element.ts` 中定义自定义元素组件
```ts
import { defineCustomElement } from 'vue'

export default defineCustomElement({
  props: {
    name: {
      type: String,
      default: 'World'
    }
  },
  emits: ['custom-click'],
  template: `
    <div>
      <div class="greeting">Hello, {{ name }}!</div>
      <button @click="handleClick">Click me</button>
    </div>
  `,
  setup(props, { emit }) {
    const handleClick = () => {
      emit('custom-click', 'Button clicked!')
    }
    
    return {
      handleClick
    }
  },
  styles: [
    `.greeting { 
      color: blue; 
      font-size: 18px;
      margin-bottom: 10px;
    }`
  ]
})
```
3.在 `main.ts` 中注册自定义元素
``` ts
// main.ts
import { defineCustomElement } from 'vue'
import CustomDefineElement from './sy-element.ts'

// 将自定义元素注册到全局
customElements.define('my-element', CustomDefineElement)
```

4.build 配置 打包自定义元素  打包后的文件为 `custom-element.js`
```typescript
// vite.config.ce.ts
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import { resolve } from 'path'

export default defineConfig({
  plugins: [
    vue({
      template: {
        compilerOptions: {
          // 将所有带 ce 的标签名都视为自定义元素
          isCustomElement: (tag) => tag.includes('my-')
        }
      }
    })
  ],
  build: {
    lib: {
      entry: resolve(__dirname, '/src/main.ts'),
      name: 'CustomElement',
      fileName: 'custom-element',
      formats: ['es','iife']
    },
    rollupOptions: {
      external: ['vue'],
      output: {
        globals: {
          vue: 'Vue'
        }
      }
    }
  }
})
```

5.在 `index.html` 中引入 `custom-element.js` 文件，即可在页面中使用自定义元素 `my-element`。

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vue Custom Element</title>
</head>
<body>
  <my-element id="element1" name="Alice1"></my-element>

  <!-- 打包后的文件 -->
  <script type="module" src="./dist/custom-element.js"></script>
</body>
</html>
```

6.运行 `npm run build:ce` 打包自定义元素，即可在 `dist` 目录下找到打包后的文件 `custom-element.js`
```json
// package.json
...
"scripts": {
  "dev": "vite --port 8080",
  "build:ce": "vite build -c vite.config.ce.ts"
},
```



