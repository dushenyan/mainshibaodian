# 如何自定义鼠标右键菜单

## 可用环境代码

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>自定义右键菜单</title>
  <style>
    /* 基础样式 */
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    
    /* 自定义右键菜单样式 */
    .custom-context-menu {
      position: fixed;
      z-index: 1000;
      width: 200px;
      background: #fff;
      border-radius: 5px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      display: none;
    }
    
    .custom-context-menu.active {
      display: block;
    }
    
    .custom-context-menu ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .custom-context-menu li {
      padding: 10px 15px;
      cursor: pointer;
    }
    
    .custom-context-menu li:hover {
      background: #f0f0f0;
    }
    
    .custom-context-menu li.divider {
      border-top: 1px solid #eee;
      padding: 0;
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <div class="content">
    <h1>自定义右键菜单演示</h1>
    <p>在此区域点击鼠标右键查看自定义菜单</p>
  </div>
  
  <!-- 自定义右键菜单结构 -->
  <div id="customContextMenu" class="custom-context-menu">
    <ul>
      <li data-action="copy">复制</li>
      <li data-action="paste">粘贴</li>
      <li class="divider"></li>
      <li data-action="refresh">刷新</li>
      <li data-action="inspect">检查元素</li>
    </ul>
  </div>

  <script>
    // 这里将放置JavaScript代码
  </script>
</body>
</html>
```

## 实现自定义右键菜单的步骤

### 1. 阻止默认右键菜单行为

首先需要阻止浏览器默认的右键菜单弹出：

```javascript
document.addEventListener('contextmenu', function(e) {
  e.preventDefault(); // 阻止默认右键菜单
});
```

### 2. 创建自定义菜单

在HTML中创建自定义菜单结构（如上面HTML代码中的`customContextMenu`）

### 3. 显示/隐藏自定义菜单

```javascript
const customMenu = document.getElementById('customContextMenu');

// 显示菜单
function showCustomMenu(x, y) {
  customMenu.style.left = `${x}px`;
  customMenu.style.top = `${y}px`;
  customMenu.classList.add('active');
}

// 隐藏菜单
function hideCustomMenu() {
  customMenu.classList.remove('active');
}

// 监听右键点击事件
document.addEventListener('contextmenu', function(e) {
  e.preventDefault();
  showCustomMenu(e.clientX, e.clientY);
});

// 点击其他地方隐藏菜单
document.addEventListener('click', hideCustomMenu);
```

### 4. 添加菜单功能

为菜单项添加点击事件处理：

```javascript
const menuItems = document.querySelectorAll('#customContextMenu li[data-action]');

menuItems.forEach(item => {
  item.addEventListener('click', function() {
    const action = this.getAttribute('data-action');
    
    switch(action) {
      case 'copy':
        console.log('执行复制操作');
        break;
      case 'paste':
        console.log('执行粘贴操作');
        break;
      case 'refresh':
        window.location.reload();
        break;
      case 'inspect':
        console.log('执行检查元素操作');
        break;
    }
    
    hideCustomMenu();
  });
});
```

### 5. 完整实现代码

```javascript
document.addEventListener('DOMContentLoaded', function() {
  const customMenu = document.getElementById('customContextMenu');
  const menuItems = document.querySelectorAll('#customContextMenu li[data-action]');
  
  // 显示自定义菜单
  function showCustomMenu(x, y) {
    // 确保菜单不会超出窗口边界
    const windowWidth = window.innerWidth;
    const windowHeight = window.innerHeight;
    const menuWidth = customMenu.offsetWidth;
    const menuHeight = customMenu.offsetHeight;
    
    x = x + menuWidth > windowWidth ? windowWidth - menuWidth : x;
    y = y + menuHeight > windowHeight ? windowHeight - menuHeight : y;
    
    customMenu.style.left = `${x}px`;
    customMenu.style.top = `${y}px`;
    customMenu.classList.add('active');
  }
  
  // 隐藏自定义菜单
  function hideCustomMenu() {
    customMenu.classList.remove('active');
  }
  
  // 阻止默认右键菜单并显示自定义菜单
  document.addEventListener('contextmenu', function(e) {
    e.preventDefault();
    showCustomMenu(e.clientX, e.clientY);
  });
  
  // 点击其他地方隐藏菜单
  document.addEventListener('click', hideCustomMenu);
  
  // 为菜单项添加功能
  menuItems.forEach(item => {
    item.addEventListener('click', function() {
      const action = this.getAttribute('data-action');
      
      switch(action) {
        case 'copy':
          console.log('执行复制操作');
          // 实际复制功能实现
          if (window.getSelection) {
            const selection = window.getSelection();
            if (selection.toString().length > 0) {
              document.execCommand('copy');
            }
          }
          break;
          
        case 'paste':
          console.log('执行粘贴操作');
          // 实际粘贴功能实现
          document.execCommand('paste');
          break;
          
        case 'refresh':
          window.location.reload();
          break;
          
        case 'inspect':
          console.log('执行检查元素操作');
          // 注意：浏览器安全限制，无法直接打开开发者工具
          break;
      }
      
      hideCustomMenu();
    });
  });
  
  // 按ESC键隐藏菜单
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      hideCustomMenu();
    }
  });
});
```

## 高级功能扩展

### 1. 根据上下文显示不同菜单

```javascript
document.addEventListener('contextmenu', function(e) {
  e.preventDefault();
  
  // 根据目标元素类型显示不同菜单
  if (e.target.tagName === 'IMG') {
    showImageContextMenu(e.clientX, e.clientY);
  } else if (e.target.tagName === 'A') {
    showLinkContextMenu(e.clientX, e.clientY);
  } else {
    showDefaultContextMenu(e.clientX, e.clientY);
  }
});

function showImageContextMenu(x, y) {
  // 显示图片相关的菜单项
  // ...
}

function showLinkContextMenu(x, y) {
  // 显示链接相关的菜单项
  // ...
}

function showDefaultContextMenu(x, y) {
  // 显示默认菜单项
  // ...
}
```

### 2. 添加子菜单

```html
<div id="customContextMenu" class="custom-context-menu">
  <ul>
    <li data-action="copy">复制</li>
    <li data-action="paste">粘贴</li>
    <li class="has-submenu">
      更多操作
      <ul class="submenu">
        <li data-action="save">保存</li>
        <li data-action="export">导出</li>
      </ul>
    </li>
  </ul>
</div>
```

```css
.has-submenu {
  position: relative;
}

.submenu {
  display: none;
  position: absolute;
  left: 100%;
  top: 0;
  width: 200px;
  background: #fff;
  border-radius: 5px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
}

.has-submenu:hover .submenu {
  display: block;
}
```

### 3. 右键菜单动画效果

```css
.custom-context-menu {
  /* ...其他样式... */
  opacity: 0;
  transform: translateY(-10px);
  transition: opacity 0.2s, transform 0.2s;
}

.custom-context-menu.active {
  opacity: 1;
  transform: translateY(0);
}
```

## 注意事项

1. **浏览器安全限制**：
   - 无法完全禁用浏览器默认右键菜单（用户可以通过浏览器设置覆盖）
   - 某些功能（如打开开发者工具）无法通过JavaScript实现

2. **移动端适配**：
   - 移动设备上的长按行为与右键不同
   - 需要额外处理触摸事件

3. **可访问性**：
   - 确保自定义菜单可以通过键盘操作
   - 添加适当的ARIA属性

4. **功能限制**：
   - 某些操作（如复制/粘贴）可能受浏览器安全策略限制
   - 现代浏览器已弃用`document.execCommand`，可能需要使用Clipboard API替代

## 现代替代方案（Clipboard API）

```javascript
// 使用现代Clipboard API替代execCommand
async function handleCopy() {
  try {
    const selection = window.getSelection();
    if (selection.toString().length > 0) {
      await navigator.clipboard.writeText(selection.toString());
      console.log('内容已复制');
    }
  } catch (err) {
    console.error('复制失败:', err);
  }
}

async function handlePaste() {
  try {
    const text = await navigator.clipboard.readText();
    console.log('粘贴内容:', text);
    // 插入到DOM中
  } catch (err) {
    console.error('粘贴失败:', err);
  }
}
```

## 总结

自定义右键菜单的实现主要包括以下几个关键点：

1. **阻止默认行为**：使用`e.preventDefault()`阻止浏览器默认右键菜单
2. **创建菜单结构**：使用HTML/CSS创建自定义菜单样式
3. **定位菜单**：根据点击位置显示菜单，并确保不超出窗口边界
4. **添加功能**：为菜单项绑定点击事件处理程序
5. **处理交互**：添加点击外部关闭、ESC键关闭等交互逻辑

完整的实现还需要考虑浏览器兼容性、移动端适配和可访问性等因素。对于复杂的应用，可以考虑使用现有的库如`contextMenu.js`或`right-click-menu`等。
