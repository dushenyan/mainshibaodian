# 空值合并运算符（??）的使用场景

空值合并运算符（Nullish Coalescing Operator）是 ES2020 引入的新特性，用 `??` 表示，它在左侧操作数为 `null` 或 `undefined` 时返回右侧操作数，否则返回左侧操作数。

## 基本用法

```javascript
const result = leftValue ?? rightValue;
```

## 实用场景示例

### 1. 默认值赋值（比 || 更安全）

```javascript
// 传统方式（|| 的问题）
const fontSize = userSettings.fontSize || 16; // 如果 fontSize 是 0，也会使用 16

// 使用 ??
const fontSize = userSettings.fontSize ?? 16; // 只有 null/undefined 时才会用 16
```

### 2. API 响应处理

```javascript
// 处理可能为 null/undefined 的 API 响应
const userData = response.data.user ?? {
  name: 'Guest',
  role: 'visitor'
};
```

### 3. 函数参数默认值

```javascript
function createUser(name, options) {
  const mergedOptions = {
    role: 'member',
    active: true,
    ...options,
    permissions: options.permissions ?? ['read']
  };
  // ...
}
```

### 4. 配置对象合并

```javascript
const defaultConfig = {
  timeout: 5000,
  retry: 3
};

const userConfig = {
  timeout: null,
  retry: undefined
};

const finalConfig = {
  ...defaultConfig,
  timeout: userConfig.timeout ?? defaultConfig.timeout,
  retry: userConfig.retry ?? defaultConfig.retry
};
```

### 5. 链式属性访问

```javascript
// 结合可选链操作符（?.）
const street = user?.address?.street ?? 'Unknown street';
```

### 6. 状态管理中的回退值

```javascript
// Redux/Vuex 中获取可能不存在的状态
const currentTheme = store.state.theme.current ?? 'light';
```

### 7. 表单输入处理

```javascript
// 处理表单输入，区分空字符串和未输入
const username = inputElement.value ?? 'anonymous';
```

### 8. 数据库查询结果处理

```javascript
// 处理数据库查询结果
const lastLogin = dbResult.lastLogin ?? new Date(0); // 从未登录则使用 Unix 纪元时间
```

## 与 || 运算符的区别

| 场景 | `??` 结果 | `11` 结果 |
|------|----------|----------|
| `false ?? true` | `false` | `true` |
| `0 ?? 1` | `0` | `1` |
| `'' ?? 'default'` | `''` | 'default' |
| `null ?? 'fallback'` | 'fallback' | 'fallback' |
| `undefined ?? 'fallback'` | 'fallback' | 'fallback' |

## 注意事项

1. **优先级**：`??` 的优先级比 `||` 低，必要时使用括号
   ```javascript
   (a ?? b) || c
   ```

2. **不能与 `||` 或 `&&` 直接混用**
   ```javascript
   // 报错
   a ?? b || c
   a || b ?? c
   ```

3. **浏览器兼容性**：现代浏览器和 Node.js 12+ 支持

## 实际代码示例

```javascript
// 用户配置处理
function processUserConfig(config) {
  return {
    theme: config.theme ?? 'dark',
    notifications: {
      email: config.notifications?.email ?? true,
      push: config.notifications?.push ?? false
    },
    meta: config.meta ?? {}
  };
}

// 使用示例
const userConfig = {
  theme: null,
  notifications: {
    push: true
  }
};

const finalConfig = processUserConfig(userConfig);
/*
{
  theme: 'dark',
  notifications: {
    email: true,
    push: true
  },
  meta: {}
}
*/
```

## 总结

空值合并运算符 `??` 最适合以下场景：
1. 需要区分 `null/undefined` 和 `false/0/''` 的情况
2. 为可能为 `null` 或 `undefined` 的值提供默认值
3. 与可选链 `?.` 配合处理深层嵌套对象
4. 需要精确控制默认值逻辑时

它比传统的 `||` 运算符更精确，能避免 `0`、`false` 和空字符串被意外覆盖的问题。
